<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="https://www.facebook.com/2008/fbml" itemscope="itemscope" itemtype="http://schema.org/Product">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="readme-deploy" content="0a76ad4a2ae68a6f7b480e04f93f1d2d4fab9046">
    <title>Phoenix</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <meta name="description" content="Productive. Reliable. Fast. A productive web framework that does not compromise speed and maintainability">
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <meta property="og:title" content="Phoenix">
    <meta property="og:description" content="Productive. Reliable. Fast. A productive web framework that does not compromise speed and maintainability">
    <meta property="og:image" content="https://files.readme.io/PKPqx8L9TJSAY2Bnmw7F_phoenixframework-logo-white@2x.png">
    <meta property="og:site_name" content="Phoenix">
    <meta id="config-proxy-url" content="https://proxy.readme.io/proxy">
    <link rel="canonical" href="http://www.phoenixframework.org/www.phoenixframework.org">
    <link rel="alternate" type="application/rss+xml" title="RSS Feed for Phoenix" href="/blog.rss">
    <link rel="stylesheet" href="/assets/css/base.css" />
    <script type="text/javascript" src="/assets/js/app.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-57337100-1', 'auto');
      ga('send', 'pageview');
    </script>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:400:sans-serif|Open+Sans:400:sans-serif" rel="stylesheet" type="text/css">
  </head>

  <body class="layout page-home body-none theme-solid header-solid header-bg-size-auto header-bg-pos-tl header-overlay-triangles lumosity-light undefined theme-threes ng-scope os-linux" cz-shortcut-listen="true">
<div class="wrapper">
  <header id="header" class="header">
    <div class="container">
      <h1 class="navbar-brand"><a href="/">Phoenix</a></h1>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://hexdocs.pm/phoenix/overview.html">Guides</a></li>
          <li><a href="https://hexdocs.pm/phoenix/Phoenix.html">Docs</a></li>
          <li><a href="/community">Community</a></li>
          <li><a href="https://github.com/phoenixframework/phoenix">GitHub</a></li>
          <li><a href="/blog" title="Blog">Blog</a></li>
        </ul>

        <ul class="nav navbar-nav pull-right">
          <li><a class="phx-book" href="https://pragprog.com/book/phoenix14/programming-phoenix-1-4" title="Book">üìô &nbsp;&nbsp; Book</a></li>
        </ul>
      </div>
    </div>
    </header>
    <br/>
<div class="container body-container">
  <div class="row">
    <div class="col-sm-3 border-right">
        <div class="sidebar-nav">
          <h4>News</h4>
          <ul>
            <li><a href="/blog/phoenix-1-4-0-released" class="active"><span>Phoenix 1.4.0 Released</span></a></li>
            <li><a href="/blog/phoenix-1-3-0-released" class="active"><span>Phoenix 1.3.0 Released</span></a></li>
            <li><a href="/blog/contribution-sprint" class="active"><span>Contribution Sprint</span></a></li>
            <li><a href="/blog/upgrading-from-120-to-130" class="active"><span>Upgrading from 1.2.x to 1.3.0</span></a></li>
            <li><a href="/blog/upgrading-from-11x-to-120" class="active"><span>Upgrading from 1.1.x to 1.2.0</span></a></li>
            <li><a href="/blog/upgrading-from-111-to-112" class="active"><span>Upgrading from 1.1.1 to 1.1.2</span></a></li>
            <li><a href="/blog/upgrading-from-v10-to-v11" class="active"><span>Upgrading from v1.0 to v1.1</span></a></li>
            <li><a href="/blog/the-road-to-2-million-websocket-connections" class="active"><span>The Road to 2 Million Websocket Connections in Phoenix</span></a></li>
            <li><a href="/blog/phoenix-10-the-framework-for-the-modern-web-just-landed"><span>Phoenix 1.0 ‚Äì the framework for the modern web just landed</span></a></li>
            <li><a href="/blog/phoenix-0100-released-with-assets-handling-generat"><span>Phoenix 0.10.0 released with assets handling, generators, &amp; more</span></a></li>
          </ul>
        </div>
    </div>
    <div class="col-sm-9 border-left">
      <div class="docs-content">
        <div class="docs-header">
          <h1>Sending Email with SMTP</h1>
          
          <hr>
        </div>
        <div class="content block-content ready">
          <h1>Sending Email with SMTP</h1>
<p>Sending email from a Phoenix application is easy with SMTP and community
libraries.</p>
<p>First you will need an SMTP service provider, such as <a href="https://aws.amazon.com/ses/">Amazon Simple Email
Service</a>, <a href="https://www.mailgun.com/">Mailgun</a>, or
<a href="https://sendgrid.com/">SendGrid</a>. Go ahead and sign up for one, often there
is a free tier that can be used to try out the service.</p>
<p>Once we have a provider, we‚Äôll need to add
<a href="https://github.com/thoughtbot/bamboo"><code class="inline">bamboo</code></a> and
<a href="https://github.com/fewlinesco/bamboo_smtp"><code class="inline">bamboo_smtp</code></a> as dependencies to
our project. We‚Äôll do that in the <code class="inline">deps/0</code> function in <code class="inline">mix.exs</code>.</p>
<pre><code class="elixir">defp deps do
  [{:phoenix, &quot;~&gt; 1.2.1&quot;},
   {:phoenix_pubsub, &quot;~&gt; 1.0&quot;},
   {:phoenix_ecto, &quot;~&gt; 3.0&quot;},
   {:postgrex, &quot;&gt;= 0.0.0&quot;},
   {:phoenix_html, &quot;~&gt; 2.6&quot;},
   {:phoenix_live_reload, &quot;~&gt; 1.0&quot;, only: :dev},
   {:gettext, &quot;~&gt; 0.11&quot;},
   {:cowboy, &quot;~&gt; 1.0&quot;},
   {:bamboo, &quot;~&gt; 0.7&quot;},
   {:bamboo_smtp, &quot;~&gt; 1.2.1&quot;}]
end</code></pre>
<p>Next, we‚Äôll need to run <code class="inline">mix deps.get</code> to bring the two new packages into our
application.</p>
<p>Once the packages have been fetched add the <code class="inline">:bamboo</code> application to our
<code class="inline">application/0</code> function in <code class="inline">mix.exs</code>.</p>
<pre><code class="elixir">def application do
  [mod: {MyApp, []},
    applications: [:phoenix, :phoenix_html, :cowboy, :logger, :gettext,
                  :phoenix_ecto, :postgrex, :bamboo]]
end</code></pre>
<h3>Configuration</h3>
<p>We‚Äôll also need to add our SMTP details to <code class="inline">config/config.ex</code>. These will be
provided by the SMTP service you signed up to, so check your account on there.</p>
<p>For security reasons, it‚Äôs important to not commit these values to a public
source code repository. There are a couple of ways we can accomplish this.</p>
<p>Set up environment variables for our <code class="inline">SMTP_USERNAME</code> and <code class="inline">SMTP_PASSWORD</code>. With
the environment variables set, we can reference them in our
<code class="inline">config/config.exs</code> file.</p>
<p>Be sure to replace <code class="inline">:my_app</code> with the atom name of your application.</p>
<pre><code class="elixir"># In your config/config.exs file
config :my_app, MyApp.Mailer,
  adapter: Bamboo.SMTPAdapter,
  server: &quot;smtp.domain&quot;,
  port: 1025,
  username: System.get_env(&quot;SMTP_USERNAME&quot;),
  password: System.get_env(&quot;SMTP_PASSWORD&quot;),
  tls: :if_available, # can be `:always` or `:never`
  ssl: false, # can be `true`
  retries: 1</code></pre>
<p>These variables will need to be set on the production servers, as well
as on our development machines. Please see the <a href="http://www.phoenixframework.org/docs/deployment">Deployment Introduction
Guide</a> for more information.</p>
<h3>The Mailer and Emails</h3>
<p>In order for our application to send emails, we‚Äôll need a mailer module. Let‚Äôs
define one here <code class="inline">lib/app/mailer.ex</code>. When we <code class="inline">use</code> the <code class="inline">Bamboo.Mailer</code> module
in the second line, we pass in the atom name of our application.</p>
<pre><code class="elixir">defmodule MyApp.Mailer do
  use Bamboo.Mailer, otp_app: :my_app
end</code></pre>
<p>We‚Äôll also need a new view module for emails. We can define this in
<code class="inline">lib/hello_web/views/email_view.ex</code>.</p>
<pre><code class="elixir">defmodule MyApp.EmailView do
  use MyApp.Web, :view
end</code></pre>
<p>Lastly we need another module that will contain our emails, which we can
define in <code class="inline">lib/my_app/email.ex</code>.</p>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView
end</code></pre>
<p>With this in place, we can start creating our custom email functions. Web
applications may send any number of different types of emails - welcome emails
after signup, password confirmations, activity notifications - the list goes
on. For each type of email, we‚Äôll define a new function which will call
<a href="https://hexdocs.pm/bamboo/0.7.0/Bamboo.Email.html#new_email/1"><code class="inline">new_email/1</code></a>
in order to build the email.</p>
<p>Let‚Äôs say we want to send a welcome email to new users formatted as plain
text. We‚Äôll need to know who to send the email to, as well as the ‚Äúfrom‚Äù
address, subject, and body of the email. This will be sent as a plain text
email because we‚Äôve specified the <code class="inline">:text</code> option.</p>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView

  def welcome_text_email(email_address) do
    new_email
    |&gt; to(email_address)
    |&gt; from(&quot;us@example.com&quot;)
    |&gt; subject(&quot;Welcome!&quot;)
    |&gt; text_body(&quot;Welcome to MyApp!&quot;)
  end
end</code></pre>
<p>Building the email is as easy as invoking the function with an email address.
Once we have the email we can then send it by piping into a delivery function
from our Mailer module. We can do this from wherever we want to in our
application.</p>
<pre><code class="elixir">MyApp.Email.welcome_text_email(&quot;us@example.com&quot;) |&gt; Mailer.deliver_now</code></pre>
<p>We can also deliver emails asyncronously in the background rather than waiting
for the email to be sent.</p>
<pre><code class="elixir">MyApp.Email.welcome_text_email(&quot;us@example.com&quot;) |&gt; Mailer.deliver_later</code></pre>
<p>See the Bamboo <a href="https://github.com/thoughtbot/bamboo#delivering-emails-in-the-background">README</a>
for more information.</p>
<h4>HTML Emails</h4>
<p>We can build HTML emails as well. To do this, we can define a new function
which builds the text email, and then pipes it into the <code class="inline">html_body/2</code> function
to add the HTML body content.</p>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView

  def welcome_text_email(email_address) do
    new_email()
    |&gt; to(email_address)
    |&gt; from(&quot;us@example.com&quot;)
    |&gt; subject(&quot;Welcome!&quot;)
    |&gt; text_body(&quot;Welcome to MyApp!&quot;)
  end

  def welcome_html_email(email_address) do
    email_address
    |&gt; welcome_text_email()
    |&gt; html_body(&quot;&lt;strong&gt;Welcome&lt;strong&gt; to MyApp!&quot;)
  end
end</code></pre>
<p>When we call the <code class="inline">welcome_html_email/1</code> function we get a multipart email that
has both text and HTML content. Clients will try to render an HTML version
first, then fall back to plain text if they are unable to do so.</p>
<h3>Using Views</h3>
<p>What we‚Äôve written so far is fine, but for a real-world welcome email, we‚Äôre
going to need more than a few words of text or a single HTML tag. With more
text or HTML, though, our email functions will become large and unwieldy quite
quickly. The solution is to reuse the Phoenix view functionality to store the
email formatting and content elsewhere.</p>
<p>In our app‚Äôs layout template directory we can create two new layouts, one for
HTML emails, one for text emails.</p>
<p><code class="inline">lib/hello_web/templates/layout/email.html.eex</code> could look like this:</p>
<pre><code class="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width&quot;&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello!&lt;/p&gt;
    &lt;%= render @view_module, @view_template, assigns %&gt;
    &lt;p&gt;- The MyApp Team.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p><code class="inline">lib/hello_web/templates/layout/email.text.eex</code> could look like this:</p>
<pre><code class="">Hello!

&lt;%= render @view_module, @view_template, assigns %&gt;

- The MyApp Team.</code></pre>
<p>Once we have these templates we can use the <code class="inline">put_text_layout/2</code> and
<code class="inline">put_html_layout/2</code> functions to wrap the content of our emails with the
layouts.</p>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView

  def welcome_text_email(email_address) do
    new_email()
    |&gt; to(email_address)
    |&gt; from(&quot;us@example.com&quot;)
    |&gt; subject(&quot;Welcome!&quot;)
    |&gt; text_body(&quot;Welcome to MyApp!&quot;)
    |&gt; put_text_layout({MyApp.LayoutView, &quot;email.text&quot;})
  end

  def welcome_html_email(email_address) do
    email_address
    |&gt; welcome_text_email()
    |&gt; html_body(&quot;&lt;strong&gt;Welcome&lt;strong&gt; to MyApp!&quot;)
    |&gt; put_html_layout({MyApp.LayoutView, &quot;email.html&quot;})
  end
end</code></pre>
<p>The process for moving the email content to a template is similar. Again we
create two new templates, one for text, one for HTML.</p>
<p><code class="inline">lib/hello_web/templates/email/welcome.html.eex</code> could look like this:</p>
<pre><code class="html">&lt;p&gt;
  &lt;strong&gt;Welcome&lt;strong&gt; to MyApp!
&lt;/p&gt;</code></pre>
<p><code class="inline">lib/hello_web/templates/email/welcome.text.eex</code> could look like this:</p>
<pre><code class="">Welcome to MyApp!</code></pre>
<p>And then we would replace the calls to <code class="inline">text_body/2</code> and <code class="inline">html_body/2</code> with a
call to <code class="inline">render/2</code>.</p>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView

  def welcome_text_email(email_address) do
    new_email()
    |&gt; to(email_address)
    |&gt; from(&quot;us@example.com&quot;)
    |&gt; subject(&quot;Welcome!&quot;)
    |&gt; put_text_layout({MyApp.LayoutView, &quot;email.text&quot;})
    |&gt; render(&quot;welcome.text&quot;)
  end

  def welcome_html_email(email_address) do
    email_address
    |&gt; welcome_text_email()
    |&gt; put_html_layout({MyApp.LayoutView, &quot;email.html&quot;})
    |&gt; render(&quot;welcome.html&quot;)
  end
end</code></pre>
<p>Now all our markup has been moved to templates, and our email building
functions are nice and simple!</p>
<p>Lastly, if we wanted variable data in our templates we would just use
assignment as usual with the view render function.</p>
<p><code class="inline">lib/hello_web/templates/email/welcome.html.eex</code> could look like this:</p>
<pre><code class="html">&lt;p&gt;
  &lt;strong&gt;Welcome&lt;strong&gt; to MyApp!
&lt;/p&gt;
&lt;p&gt;
  Your email address is &lt;%= @email_address %&gt;
&lt;/p&gt;</code></pre>
<pre><code class="elixir">defmodule MyApp.Email do
  use Bamboo.Phoenix, view: MyApp.EmailView

  def welcome_text_email(email_address) do
    new_email()
    |&gt; to(email_address)
    |&gt; from(&quot;us@example.com&quot;)
    |&gt; subject(&quot;Welcome!&quot;)
    |&gt; put_text_layout({MyApp.LayoutView, &quot;email.text&quot;})
    |&gt; render(&quot;welcome.text&quot;)
  end

  def welcome_html_email(email_address) do
    email_address
    |&gt; welcome_text_email()
    |&gt; put_html_layout({MyApp.LayoutView, &quot;email.html&quot;})
    |&gt; render(&quot;welcome.html&quot;, email_address: email_address) # &lt;= Assignments
  end
end</code></pre>
<h3>Further Information</h3>
<p>To learn more about using the Bamboo email library see the <a href="https://github.com/thoughtbot/bamboo#readme">Bamboo
documentation</a>.</p>

        </div>
      </div>
    </div>
  </div>
</div>

  </div>
  </body>
</html>
